# 数据库基础知识

目录

## 1 事务

### 1.1 事务的定义

事务是一个不可分割的数据库操作序列，也是数据库并发控制的基本单位.事务是逻辑上的一组操作，要么都执行，要么都不执行。

例：

```sql
START TRANSACTION;// 开始事务
INSERT ...... ;
INSERT ...... ;
UPDATE ...... ;
COMMIT;// 提交事务
// 出现异常时
// ROLLBACK; // 回滚
```

### 1.2 事务的特性

事务有四个特性：`ACID`

+ `原子性Atomicity` 一个事务中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。
+ `一致性Consistency` 在事务开始之前和事务结束以后，数据库的完整性没有被破坏，写入之前和写入之后的数据必须完全符合预期。
+ `隔离性Isolation` 每个事务都是彼此独立的，不会受到其他事务的执行影响。隔离性保证了事务在并发执行时，执行结果符合预期。
+ `持久性Durability` 事务提交之后对数据的修改是持久性的，即使发生故障时，也可以通过日志文件进行恢复。

>ACID四个特性中，原子性是基础，一致性是约束条件，隔离性是手段，而持久性是目的。

### 1.3 事务的隔离

#### 1.3.1 并发异常

##### 脏读

假设数据库中 $x = 1$

| TRANSACTION A | TRANSACTION B |
| :------: | :------: |
| BEGIN |  |
|  | BEGIN |
|  | WRITE(x) <- 2|
| READ(x) -> 2 |  |
| ... | ... |
| COMMIT |  |
|  | COMMIT |

显然 `事务A` 在 `事务B` 提交前就读到了已修改的结果，这是不合理的。

`脏读` 就是读到了其他事务还没有提交的数据。

##### 不可重复读

假设数据库中 $x = 1$

| TRANSACTION A | TRANSACTION B |
| :------: | :------: |
| BEGIN |  |
| READ(x) -> 1 |  |
|  | BEGIN |
|  | WRITE(x) <- 2|
|  | COMMIT |
| ... |  |
| READ(x) -> 2 |  |
| COMMIT |  |

显然 `事务A` 在整个事务过程中读到了不同的 $x$ 。

`不可重复读` 就是在一个事务中，任意时刻读到的同一批数据出现不一致的情况。

##### 幻读

假设数据库中存在记录 ${a,b,c}$

| TRANSACTION A | TRANSACTION B |
| :------: | :------: |
| BEGIN |  |
|  | BEGIN |
|  | INSERT(x) |
|  | COMMIT |
| ... |  |
| SELECT * -> {a,b,c,x} |  |
| COMMIT |  |

显然，`事务A` 并没有与预想到会多出一条记录 $x$ 。

`幻读` 就是读到了 **不在预期之中** 的一条或多条记录，仿佛幻觉一样。

#### 1.3.2 隔离级别

脏读、不可重复读和幻读这三种异常情况，是在 `SQL-92` 中定义的，同时SQL-92还定义了4种隔离级别来解决这些异常情况：

|  | 脏读 | 不可重复读 | 幻读 |
| :------: | :------: | :------: | :------: |
| 读未提交 | 允许 | 允许 | 允许 |
| 读已提交 | 禁止 | 允许 | 允许 |
| 可重复读 | 禁止 | 禁止 | 允许 |
| 可串行化 | 禁止 | 禁止 | 禁止 |

随着隔离级别的提高，并发程度就会降低。
